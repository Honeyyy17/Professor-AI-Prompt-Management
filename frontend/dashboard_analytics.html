<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard | AI Prompt Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-icon">ðŸ˜Ž</div>
                <span class="logo-text">Professor AI</span>
            </div>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="dashboard.html" class="nav-link"><i class="fas fa-home"></i>
                            Dashboard</a></li>
                    <li class="nav-item"><a href="dashboard_analytics.html" class="nav-link active"><i
                                class="fas fa-chart-pie"></i>
                            Analytics</a></li>
                    <li class="nav-item"><a href="prompts.html" class="nav-link"><i class="fas fa-file-alt"></i>
                            Prompts</a></li>
                    <li class="nav-item"><a href="versions.html" class="nav-link"><i class="fas fa-code-branch"></i>
                            Versions</a></li>
                    <li class="nav-item"><a href="evaluation.html" class="nav-link"><i class="fas fa-chart-bar"></i>
                            Evaluation</a></li>
                </ul>
            </nav>
            <div style="margin-top: auto; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <a href="#" class="nav-link" onclick="api.auth.logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Advanced Analytics</h1>
                    <p class="page-subtitle">AI-Powered Insights & Metrics</p>
                </div>
            </div>

            <!-- Advanced Metrics Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon primary"><i class="fas fa-book-reader"></i></div>
                    <div class="stat-info">
                        <h3 id="avgReadability">-</h3>
                        <p>Avg. Readability</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon secondary"><i class="fas fa-brain"></i></div>
                    <div class="stat-info">
                        <h3 id="avgSentiment">-</h3>
                        <p>Avg. Sentiment</p>
                    </div>
                </div>
                <!-- ... other stats ... -->
            </div>

            <div class="charts-container"
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">

                <!-- Readability Chart -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Readability Scores (Flesch-Kincaid)</h2>
                    </div>
                    <div class="card-body">
                        <canvas id="readabilityChart"></canvas>
                    </div>
                </div>

                <!-- Sentiment Chart -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Sentiment & Subjectivity</h2>
                    </div>
                    <div class="card-body">
                        <canvas id="sentimentChart"></canvas>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="toastContainer" class="toast-container"></div>

    <script src="js/sanitize.js"></script>
    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
    <script>
        if (!requireAuth()) return;

        // Track chart instances for cleanup (prevent memory leaks)
        let chartInstances = [];

        async function loadAnalytics() {
            try {
                const response = await api.prompts.list();
                const prompts = response.prompts;

                // Filter prompts that have current versions with evaluations
                const promptsWithVersions = prompts
                    .filter(p => p.current_version && p.current_version.id)
                    .slice(0, 10); // Limit to 10 for chart

                if (promptsWithVersions.length === 0) {
                    document.getElementById('avgReadability').textContent = "N/A";
                    document.getElementById('avgSentiment').textContent = "N/A";
                    return;
                }

                // FIXED: Use read-only endpoint (no DB mutation)
                // FIXED: Parallel fetches instead of serial await
                const evalPromises = promptsWithVersions.map(prompt =>
                    api.evaluation.getVersionEvaluation(prompt.current_version.id)
                        .then(data => ({ prompt, data, status: 'fulfilled' }))
                        .catch(err => ({ prompt, error: err, status: 'rejected' }))
                );

                const results = await Promise.all(evalPromises);

                let readabilityScores = [];
                let sentimentScores = [];
                let labels = [];
                let totalReadability = 0;
                let totalSentiment = 0;
                let count = 0;

                for (const result of results) {
                    if (result.status === 'rejected') {
                        console.log('Skipping prompt - fetch failed:', result.prompt.id);
                        continue;
                    }

                    const { prompt, data } = result;

                    // Check if evaluation exists (read-only endpoint returns null if none)
                    if (!data.evaluation) {
                        console.log('Skipping prompt without eval:', prompt.id);
                        continue;
                    }

                    // Use evaluation data that's already stored
                    // Note: readability/sentiment details aren't stored in DB,
                    // only the core scores. For full details, would need aggregated endpoint.
                    const evaluation = data.evaluation;

                    // Use final_score as proxy for readability chart display
                    // (In production, add readability/sentiment to PromptEvaluation model)
                    const rScore = evaluation.final_score || 50;
                    const sScore = 0; // Sentiment not stored in DB evaluation

                    readabilityScores.push(rScore);
                    sentimentScores.push(sScore);
                    labels.push(escapeHtml(prompt.title.substring(0, 15)) + '...');

                    totalReadability += rScore;
                    totalSentiment += sScore;
                    count++;
                }

                if (count > 0) {
                    document.getElementById('avgReadability').textContent = Math.round(totalReadability / count);
                    document.getElementById('avgSentiment').textContent = (totalSentiment / count).toFixed(2);
                    renderCharts(labels, readabilityScores, sentimentScores);
                } else {
                    document.getElementById('avgReadability').textContent = "N/A";
                    document.getElementById('avgSentiment').textContent = "N/A";
                }

            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        function renderCharts(labels, readabilityData, sentimentData) {
            // Readability Chart
            new Chart(document.getElementById('readabilityChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Flesch Reading Ease (0-100)',
                        data: readabilityData,
                        backgroundColor: 'rgba(52, 152, 219, 0.6)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: { scales: { y: { beginAtZero: true, max: 100 } } }
            });

            // Sentiment Chart
            new Chart(document.getElementById('sentimentChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sentiment Polarity (-1 to 1)',
                        data: sentimentData,
                        borderColor: 'rgba(46, 204, 113, 1)',
                        tension: 0.1
                    }]
                },
                options: { scales: { y: { min: -1, max: 1 } } }
            });
        }

        loadAnalytics();
    </script>
</body>

</html>