<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Versions | AI Prompt Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-icon">ðŸ˜Ž</div>
                <span class="logo-text">Professor AI</span>
            </div>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="dashboard.html" class="nav-link"><i class="fas fa-home"></i>
                            Dashboard</a></li>
                    <li class="nav-item"><a href="prompts.html" class="nav-link"><i class="fas fa-file-alt"></i>
                            Prompts</a></li>
                    <li class="nav-item"><a href="versions.html" class="nav-link active"><i
                                class="fas fa-code-branch"></i> Versions</a></li>
                    <li class="nav-item"><a href="evaluation.html" class="nav-link"><i class="fas fa-chart-bar"></i>
                            Evaluation</a></li>
                </ul>
            </nav>
            <div style="margin-top: auto; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <a href="#" class="nav-link" onclick="api.auth.logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Version Control</h1>
                    <p class="page-subtitle" id="promptInfo">Select a prompt to view versions</p>
                </div>
                <div class="page-actions">
                    <button class="btn btn-secondary" onclick="openModal('editPromptModal')"><i class="fas fa-edit"></i>
                        Edit Prompt</button>
                </div>
            </div>

            <!-- Prompt Selector -->
            <div class="card mb-lg">
                <div class="form-group mb-0">
                    <label class="form-label">Select Prompt</label>
                    <select id="promptSelector" class="form-select" onchange="loadVersions()">
                        <option value="">-- Select a prompt --</option>
                    </select>
                </div>
            </div>

            <!-- Current Version -->
            <div class="card mb-lg" id="currentVersionCard" style="display: none;">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-star text-primary"></i> Current Version</h2>
                    <span class="badge badge-success" id="currentVersionBadge">v1</span>
                </div>
                <div class="card-body">
                    <pre style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; white-space: pre-wrap; font-family: var(--font-mono); font-size: 0.875rem;"
                        id="currentVersionText"></pre>
                </div>
            </div>

            <!-- Version History -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Version History</h2>
                    <span class="text-muted" id="versionCount">0 versions</span>
                </div>
                <div class="card-body" id="versionsContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon"><i class="fas fa-code-branch"></i></div>
                        <h3>Select a prompt</h3>
                        <p>Choose a prompt from the dropdown to view its version history.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Prompt Modal -->
    <div class="modal-overlay" id="editPromptModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Edit Prompt (New Version)</h2>
                <button class="modal-close" onclick="closeModal('editPromptModal')"><i
                        class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form id="editPromptForm">
                    <div class="form-group">
                        <label class="form-label">Prompt Text</label>
                        <textarea id="editPromptText" class="form-textarea" rows="8" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Change Notes</label>
                        <input type="text" id="editChangeNotes" class="form-input"
                            placeholder="What changed in this version?">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('editPromptModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveNewVersion()"><i class="fas fa-save"></i> Save as New
                    Version</button>
            </div>
        </div>
    </div>

    <div id="toastContainer" class="toast-container"></div>

    <script src="js/sanitize.js"></script>
    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
    <script>
        (async function () {
            if (!requireAuth()) return;

            let currentPromptId = null;
            let currentPrompt = null;

            async function loadPromptsList() {
                try {
                    const data = await api.prompts.list();
                    const selector = document.getElementById('promptSelector');
                    data.prompts.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = `${p.title} (${p.task_type})`;
                        selector.appendChild(option);
                    });

                    // Check URL for prompt_id
                    const urlParams = new URLSearchParams(window.location.search);
                    const promptId = urlParams.get('prompt_id');
                    if (promptId) {
                        selector.value = promptId;
                        loadVersions();
                    }
                } catch (error) {
                    showToast(error.message, 'error');
                }
            }

            async function loadVersions() {
                const promptId = document.getElementById('promptSelector').value;
                if (!promptId) return;

                currentPromptId = promptId;

                try {
                    const data = await api.versions.list(promptId);
                    const promptData = await api.prompts.get(promptId);
                    currentPrompt = promptData.prompt;

                    document.getElementById('promptInfo').textContent = `${currentPrompt.title} - ${currentPrompt.task_type}`;
                    document.getElementById('versionCount').textContent = `${data.total} versions`;

                    // Current version
                    const current = currentPrompt.current_version;
                    if (current) {
                        document.getElementById('currentVersionCard').style.display = 'block';
                        document.getElementById('currentVersionBadge').textContent = `v${current.version_number}`;
                        document.getElementById('currentVersionText').textContent = current.prompt_text;
                        document.getElementById('editPromptText').value = current.prompt_text;
                    }

                    // Version list
                    const container = document.getElementById('versionsContainer');
                    if (data.versions.length > 0) {
                        container.innerHTML = `<div class="version-list">${data.versions.map(v => renderVersionItem(v, promptId)).join('')}</div>`;
                    } else {
                        container.innerHTML = '<p class="text-muted">No versions found.</p>';
                    }
                } catch (error) {
                    showToast(error.message, 'error');
                }
            }

            async function setCurrentVersion(versionId, promptId) {
                try {
                    await api.versions.setCurrent(versionId);
                    showToast('Version set as current!', 'success');
                    loadVersions();
                } catch (error) {
                    showToast(error.message, 'error');
                }
            }

            async function evaluateVersion(versionId) {
                window.location.href = `evaluation.html?version_id=${versionId}`;
            }

            async function saveNewVersion() {
                if (!currentPromptId) return;

                try {
                    await api.prompts.update(currentPromptId, {
                        prompt_text: document.getElementById('editPromptText').value,
                        change_notes: document.getElementById('editChangeNotes').value
                    });
                    showToast('New version created!', 'success');
                    closeModal('editPromptModal');
                    loadVersions();
                } catch (error) {
                    showToast(error.message, 'error');
                }
            }

            // Expose functions globally for onclick handlers
            window.loadVersions = loadVersions;
            window.setCurrentVersion = setCurrentVersion;
            window.evaluateVersion = evaluateVersion;
            window.saveNewVersion = saveNewVersion;

            loadPromptsList();
        })();
    </script>
</body>

</html>